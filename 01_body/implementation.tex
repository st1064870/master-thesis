\chapter{Υλοποίηση}
\label{chapter:implementation}

Στο κεφάλαιο αυτό θα περιγράψουμε την πειραματική υλοποίηση που πραγματοποιήθηκε στα πλαίσια αυτής της διπλωματικής εργασίας. Πρόκειται για την υλοποίηση Βασικών Υπορουτινών Γραμμικής Άλγεβρας (Basic Linear Algebra Subroutines ή BLAS) Επιπέδου 1 για Ασφαλή Υπολογισμό Δύο Μερών η οποία βασίζεται στην βιβλιοθήκη ABY για την εκτέλεση των πρωταρχικών κρυπτογραφικών και ασφαλούς υπολογισμού διεργασιών. Την βιβλιοθήκη που υλοποιήσαμε ονομάζουμε MPC-BLAS, ωστόσο ένα ίσως καταλληλότερο όνομα θα ήταν το 2PCBLAS. Πρωτού περάσουμε στην ανάλυση της MPC-BLAS βιβλιοθήκης, πρέπει πρώτα να αναλύσουμε  ένα λιγότερο κρυπτογραφικό κομμάτι αυτής της εργασίας, τις απλές BLAS βιβλιοθήκες.

\section{Η διεπαφή BLAS}

Η Γραμμική Άλγεβρα αποτλεί πλέον θεμελιώδες μαθηματικό εργαλείο των θετικών επιστήμων, για αυτό και αποτελεί βασικό μάθημα των πρώτων ετών των προπτυχιακών σπουδών σε σχεδόν όλες τις σχολές θετικών επιστημών. Εξετάζωντας μόνο την επιστήμη της πληροφορικής, την βλέπουμε σε πάρα κλάδους της, όπως την Μηχανική Μάθηση (π.χ. SVM), στην Ψηφιακή Επεξερφασία Σημάτων (π.χ. FFT), στην Αριθμητική Ανάλυση, στην Κρυπτογραφία (π.χ. Κρυπτογραφία Πλεγμάτων), στα Γραφικά Υπολογιστών (π.χ. Ray Tracers) καθώς και σε πολλούς ακόμα. Η μαζικότητα αυτή, της χρήσης της γραμμικής άλγεβρας, δημιούργησε από τα πρώτα χρόνια των γλωσσών προγραμματισμού την επιτακτική ανάγκη για την εκτέλεση γρήγορων πράξεων γραμμικής άλγεβρας. Έτσι, από τα χρόνια της γλώσσας Fortan, εγκαθιδρύθηκε από το BLAS Technical Foroum ένα πρώτυπο, μια διεπαφή συναρτήσεων, την οποία μπορούν να χρησιμοποιούν τα προγράμματα Fortran (Basic Linear Algebra Subroutines ή BLAS). Ο σκοπός της διεπαφής αυτής είναι η υλοποίηση να μπορεί να είναι διαφορετική
από πλατφόρμα σε πλατφόρμα, ώστε να εκμεταλλέυεται τις ιδιομορφίες του υλικού της κάθε πλατφόρμας. Κρατώντας την διεπαφή σταθερή δεν χρειάζεται να αλλάξει ένα πρόγραμμα που την χρησιμοποιεί. Το μόνο που χρειάζεται να γίνει είναι να ξανά μεταγλωττιστεί το πρόγραμμα για την συγκεκριμένη πλατφόρμα και να συνδεθεί (linked) με την νέα BLAS υλοποίηση. Μάλιστα στην περίπτωση που η BLAS υλοποίηση υποστηρίζει δυναμική σύνδεση (dynamic linking) μπορεί να μην είναι απαρραίτητο να ξαναμεταγλωττιστεί το πρόγραμμα για την συγκεκριμένη πλατφόρμα. Με την έλευση της γλώσσας C, δημιουργήθηκε αντίστοιχη διεπαφή για την C όπως και με αυτή της Fortran. Έχει επικρατήσει να καλούμε την διεπαφή για την Fortran ως BLAS ενώ για την C ως CBLAS.

Γενικότερα, η ύπαρξη τέτοιου είδους διεπαφής δίνει την δυνατότητα σε κατσκευαστές υλικού, για παράδειγμα επεξεργαστών ή καρτών γραφικών, να δημιουργήσουν BLAS υλοποιήσεις που να εκμεταλλέυονται τα χαρακτηριστικά των κάθε υλικού τους. Έτσι σήμερα υπάρχουν στη βιβλιογραφία πάρα πολλές υλοποιήσεις της διεπαφής BLAS, ανοιχτού ή κλειστού κώδικα, από ποικοίλους συγγραφείς, μεταξύ των οποίων και οι μεγαλύτεροι κατασκευαστές υλικού επεξεργαστών και καρτών γραφικών.

% Η διεπαφή BLAS, χωρίζεται σε τρία επίπεδα. Το δεύτερο επίπεδο περιέχει πράξεις μόνο μεταξύ διανυσμάτων ή γενικότερα πράξεις επάνω σε διανύσματα, όπως για παράδειγμα η εύρεση της θέσεις του στοιχείου με την μεγαλύτερη απόλυτη τιμή (πράξη IxAMAX). Το δεύτερο επίπεδο περιέχει μόνο πράξεις μεταξύ πινάκων και διανυσμάτων ενώ το τρίτο επίπεδο περιέχει μόνο πράξεις μεταξύ πινάκων. Στα πλαίσια της εργασίας αυτής θα αναφερθούμε μόνο στις πράξεις του πρώτου επιπέδου οι οποίες φαίνονται συνοπτικά και με αφαιρετικό τρόπο στο Σχήμα \ref{code:blas-level-1}, ολόκληρη η διεπαφή BLAS βρίσκεται στην \improvement{Add reference}. Οι ονομασίες που χρησιμοποιούντε για τις συναρτήσεις και τις υπορουτίνες είναι στην μορφή xDOT. Το x είναι ένας χαρακτήρας μπαλαντέρ που παίρνει τιμές S, D, C, Z ανάλογα με το αν αναφερόμαστε σε πραγματικούς αριθμούς, μονής ή διπλή ακρίβειας, ή σε μιγαδικούς αριθμούς, μονής ή διπλής ακρίβειας, αντίστοιχα. Για παράδειγμα η αντίστοιχη διεπαφή CBLAS, για την συνάρτηση xDOT, φαίνεται στο Σχήμα \ref{code:cblas-level-1}. Ολόκληρη η διεπαφή CBLAS βρίσκεται στην \improvement{Add reference}.

% Στο παράδειγμα του Σχήματος \ref{code:blas-level-1}, ως συναρτήσεις (functions) θεωρούνται αυτές που επιστρέφουν την έξοδο τους ως την επιστρεφόμενη τιμή. Ωστόσο δεν δεν είναι εμφανές με ποιον τρόπο γίνεται η επιστροφή των εξόδων των υπορουτινών. Αυτή γίνεται με επιστροφή μέσω αναφοράς (return by reference). Έτσι για παράδειγμα η υπορουτίνα xAXPY τοποθετεί την καινούργια τιμή του $Y$ στην διεύθυνση που βρίσκεται η παλιά του τιμή. Οι οι παραμέτροι $INCx$ που βρίσκονται σε όλες τις συναρτήσεις που παίρνουν ως όρισμα ένα διάνυσμα καθορίζουν το βήμα θα διαβαστούν οι τιμές του διανύσματος. Αν θέλουμε να χρησιμοποιήσουμε ολόκληρο το διάνυσμα $X$ μπορούμε να χρησιμοποιήσουμε $INCX=1$ ενώ αν θέλουμε να διαβάσουμε μόνο τις τιμές που βρίσκονται στις άρτιες θέσεις του μπορούμε να χρησιμοποιήσουμε την τιμή $INCX=2$. Τέλος η τιμή $N$ είναι ο αριθμός των τιμών που θα διαβαστούν από το κάθε διάνυσμα.

\begin{figure}
    \centering
\[
\scalemath{0.6}{
\begin{array}{lllllllllllllllll}
%  & &  & dim & scalar & vector \\
SUBROUTINE & xROTG  & ( & N, & X, & INCX, & Y, & INCY, & D1, & D2, & A, & B, & C, & S, & PARAM & ) & \text{Generate plane rotation}\\
SUBROUTINE & xROTMG & ( & N, & X, & INCX, & Y, & INCY, & D1, & D2, & A, & B, & C, & S, & PARAM & ) & \text{Generate modified plane rotation}\\
SUBROUTINE & xROT   & ( & N, & X, & INCX, & Y, & INCY, & D1, & D2, & A, & B, & C, & S, & PARAM & ) & \text{Apply plane rotation}\\
SUBROUTINE & xROTM  & ( & N, & X, & INCX, & Y, & INCY, & D1, & D2, & A, & B, & C, & S, & PARAM & ) & \text{Apply modified plane rotation}\\
SUBROUTINE & xSWAP  & ( & N, & X, & INCX, & Y, & INCY, & D1, & D2, & A, & B, & C, & S, & PARAM & ) & x \leftrightarrow y\\
SUBROUTINE & xSCAL  & ( & N, & X, & INCX, & Y, & INCY, & D1, & D2, & A, & B, & C, & S, & PARAM & ) & x \leftarrow y\\
SUBROUTINE & xCOPY  & ( & N, & X, & INCX, & Y, & INCY, & D1, & D2, & A, & B, & C, & S, & PARAM & ) & y \leftarrow x\\
SUBROUTINE & xAXPY  & ( & N, & X, & INCX, & Y, & INCY, & D1, & D2, & A, & B, & C, & S, & PARAM & ) & y \leftarrow ax + y\\
FUNCTION   & xDOT   & ( & N, & X, & INCX, & Y, & INCY, & D1, & D2, & A, & B, & C, & S, & PARAM & ) & dot \leftarrow x^Ty\\
FUNCTION   & xDOT   & ( & N, & X, & INCX, & Y, & INCY, & D1, & D2, & A, & B, & C, & S, & PARAM & ) & dot \leftarrow x^Ty\\
FUNCTION   & xDOTU  & ( & N, & X, & INCX, & Y, & INCY, & D1, & D2, & A, & B, & C, & S, & PARAM & ) & dot \leftarrow x^Hy\\
FUNCTION   & xDOTC  & ( & N, & X, & INCX, & Y, & INCY, & D1, & D2, & A, & B, & C, & S, & PARAM & ) & \dot \leftarrow a + x^Ty\\
FUNCTION   & xxDOT  & ( & N, & X, & INCX, & Y, & INCY, & D1, & D2, & A, & B, & C, & S, & PARAM & ) &  dot \leftarrow a + x^Ty\\
FUNCTION   & xNRM2  & ( & N, & X, & INCX, & Y, & INCY, & D1, & D2, & A, & B, & C, & S, & PARAM & ) & nrm2 \leftarrow \abs{x}_2\\
FUNCTION   & xASUM  & ( & N, & X, & INCX, & Y, & INCY, & D1, & D2, & A, & B, & C, & S, & PARAM & ) & asum \leftarrow \abs{re(x)}_1 + \abs{im(x)}_1\\
FUNCTION   & IxAMAX & ( & N, & X, & INCX, & Y, & INCY, & D1, & D2, & A, & B, & C, & S, & PARAM & ) & amax \leftarrow 1^{st}k \abs{re(x_k)} + \abs{im(x)}_1\\
\end{array}
}
\]
    \caption{Πίνακας Βασικών Υπορουτινών Γραμμικής Άλγεβρας - Επιπέδου 1 (BLAS-Level 1)}
    \label{code:blas-level-1}
\end{figure}

\begin{longlisting}
    \begin{center}
        \inputminted[fontsize=\scriptsize,frame=single]{c}{./01_body/code/cblas-level-1.h}
    \end{center}
    \caption{Διεπαφή CBLAS Επιπέδου 1.}
    \label{code:cblas-level-1}
\end{longlisting}

\section{Η βιβλιοθήκη MPC-BLAS}

Στα πλαίσια αυτής της εργασίας υλοποιήθηκε η βιβλιοθήκη MPC-BLAS. Πρόκειται για μια πειραματική βιβλιοθήκη που ο απότερος σκοπός της είναι να μπορέσει να αποτελέσει ένα σχεδόν "drop-in" αντικατάστατο μιας BLAS βιβλιοθήκης. 


\section{Βασικές Υπορουτίνες Γραμμικής Άλγεβρας}


\section{Η βιβλιοθήκη MPCBLAS}

\subsection{Συνοπτική παρουσίαση}

\subsection{Υλοποίηση}

\subsection{Διεπαφή}

\subsection{Χρήση}

\subsubsection{Παράδειγμα χρήσης}